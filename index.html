<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Pandazware Key System</title>

<style>
* { box-sizing: border-box; font-family: Arial, sans-serif; }
body {
    margin: 0;
    height: 100vh;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}
.container {
    background: rgba(0,0,0,0.4);
    padding: 30px;
    border-radius: 16px;
    width: 100%;
    max-width: 380px;
    text-align: center;
    backdrop-filter: blur(5px);
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
}
h1 { margin-bottom: 10px; font-size: 24px; }
p { opacity: 0.8; margin-bottom: 20px; }

button {
    width: 100%;
    padding: 14px;
    margin-top: 15px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: bold;
}
button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Button Styles */
#actionBtn { background: #00c6ff; color: #000; }
#actionBtn:hover:not(:disabled) { background: #0072ff; color: white; }

#copy { background: #4caf50; color: white; display: none; margin-top: 10px; }
#copy:hover { background: #45a049; }

/* Status Box */
.key-box {
    background: rgba(0,0,0,0.3);
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
    word-break: break-all;
    font-family: monospace;
    display: none;
    border: 1px solid rgba(255,255,255,0.1);
}

.error { color: #ff6b6b; font-size: 14px; margin-top: 10px; display: none; }
.loader { border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="container">
    <h1>Pandazware Key</h1>
    <p id="statusText">Please complete the verification step.</p>

    <div id="loader" class="loader"></div>

    <button id="actionBtn" onclick="handleAction()">Complete Verification</button>

    <div id="keyBox" class="key-box"></div>
    
    <button id="copy" onclick="copyKey()">Copy Key</button>

    <div id="errorMsg" class="error"></div>
</div>

<script>
    let globalToken = null;
    const actionBtn = document.getElementById("actionBtn");
    const statusText = document.getElementById("statusText");
    const errorMsg = document.getElementById("errorMsg");
    const loader = document.getElementById("loader");
    const keyBox = document.getElementById("keyBox");
    const copyBtn = document.getElementById("copy");

    // Init: Prüfe ob User von Linkvertise zurückkommt
    (async function init() {
        const params = new URLSearchParams(window.location.search);
        const token = params.get("token");

        if (token) {
            // Ladezustand anzeigen
            setLoading(true);
            actionBtn.style.display = 'none';
            statusText.innerText = "Validating session...";

            try {
                // Token prüfen
                const req = await fetch(`/api/validate-token?token=${token}`);
                const res = await req.json();

                if (res.valid) {
                    // Token ist gültig
                    globalToken = token;
                    statusText.innerText = "Verification complete!";
                    actionBtn.innerText = "Generate Key";
                    actionBtn.style.display = 'block';
                    actionBtn.onclick = generateKey; // Funktion ändern
                } else {
                    // Token ungültig
                    showError("Invalid or expired session. Please try again.");
                    actionBtn.style.display = 'block';
                    actionBtn.innerText = "Complete Verification";
                    actionBtn.onclick = startVerification;
                }
            } catch (e) {
                showError("Connection error.");
                actionBtn.style.display = 'block';
            }
            setLoading(false);
        } else {
            // Kein Token -> Normaler Start
            actionBtn.onclick = startVerification;
        }
    })();

    // Schritt 1: Start Linkvertise Flow
    function startVerification() {
        // Leitet zu api/init weiter, was den Token generiert und zu Linkvertise redirectet
        window.location.href = "/api/init";
    }

    // Schritt 2: Key generieren (wenn Token vorhanden)
    async function generateKey() {
        if (!globalToken) return;

        setLoading(true);
        actionBtn.disabled = true;
        errorMsg.style.display = 'none';

        try {
            const req = await fetch(`/api/generate?token=${globalToken}`);
            const res = await req.json();

            if (res.success) {
                // Erfolg
                statusText.innerText = "Key Generated successfully!";
                actionBtn.style.display = 'none';
                
                keyBox.innerText = res.key;
                keyBox.style.display = 'block';
                copyBtn.style.display = 'block';
                
                // Optional: Zeige Ablaufzeit oder Cooldown an
                if(res.nextKeyIn) {
                    const info = document.createElement('div');
                    info.style.fontSize = "12px";
                    info.style.marginTop = "10px";
                    info.style.opacity = "0.7";
                    info.innerText = `Next key in: ${res.nextKeyIn}`;
                    document.querySelector('.container').appendChild(info);
                }

            } else {
                // Fehler (z.B. Cooldown oder Token ungültig)
                showError(res.message || "Failed to generate key.");
                actionBtn.disabled = false;
                
                // Falls Token ungültig war, Reset
                if(res.message && res.message.includes("session")) {
                    setTimeout(() => window.location.href = "/", 3000);
                }
            }
        } catch (e) {
            showError("Server error occurred.");
            actionBtn.disabled = false;
        }
        setLoading(false);
    }

    function copyKey() {
        const text = keyBox.innerText;
        navigator.clipboard.writeText(text).then(() => {
            copyBtn.innerText = "✓ Copied!";
            setTimeout(() => copyBtn.innerText = "Copy Key", 2000);
        });
    }

    function setLoading(isLoading) {
        if(isLoading) {
            loader.style.display = 'block';
        } else {
            loader.style.display = 'none';
        }
    }

    function showError(msg) {
        errorMsg.innerText = msg;
        errorMsg.style.display = 'block';
    }

    // Einfacher Schutz gegen Inspect Element / Debugging (Optional)
    document.addEventListener('contextmenu', event => event.preventDefault());
    document.onkeydown = function(e) {
        if(e.keyCode == 123) { return false; }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { return false; }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { return false; }
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { return false; }
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { return false; }
    }
</script>

</body>
</html>
